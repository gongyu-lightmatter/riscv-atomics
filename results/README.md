# RISC-V Atomics Results

The following results are from an intrinsics comparison between the GCC 8.1
_(build-date 29-Jun-2018)_ atomic intrinsics, the hand-coded assembly
alternatives herein, and C/C++ Atomic primitives guidelines in the The
RISC-V Instruction Set Manual Volume I: User-Level ISA Document
Version 2.3-draft _(build-date 7-Feb-2019)_.

```
$ riscv64-unknown-elf-gcc --version
riscv64-unknown-elf-gcc (GCC) 8.1.0
Copyright (C) 2018 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

## Observations

Below are draft observations, subject to further verification. The
observations are based on the C/C++ mappings present in the ISA manual.
These results will be updated from time-to-time, including comparisons
with more recent compiler versions.

Here is a summary of the observations:

- Logic bug in `atomic_flag_clear`
- Missing or incorrect `.aqrl` flags on atomic operations _(add,and,or,xor)_
- Missing or incorrect `.aqrl` flags on atomic load reserve, store conditional
- Use of IO flags on fence instructions generated by intrinsics
  - Should only used in kernel code or with special attributes
  - IO fence flags may incur higher overhead with some micro-architectures
  - Expect these falgs in in-line assembly (e.g. `eieio` on PowerPC)
    or to be generated with if special attributes are present.
- Use of `amoswap` vs with zero register versus plain stores plus `fence rw,w`
  - Favour use of simple store
    - a). `atomic_load` and `atomic_store` can be used without the A extension.
    - b). incompatible access control requirements (_RW_ vs _W_).
    - c). code density not an argument for synchronisation primitives.
    - d). consistency with stores of other widthes, e.g. byte and half.
    - e). micro-architectural cost of atomic operation versus fence instruction,
          the former requiring special bus operations versus the later which
          uses the regular fence instruction for memory access ordering.

### atomic_compare_exchange

- `memory_order_release`
  - missing `.rl` on `sc`
- `memory_order_acq_rel`
  - erroneous `.rl` on `lr`
  - missing `.aq` on `lr`
  - missing `.rl` on `sc`
- `memory_order_seq_cst`
  - missing `.aq` on `lr`
  - missing `.rl` on `sc`

### atomic_store

- `memory_order_release`, `memory_order_seq_cst`
  - use of `amoswap` vs plain loads and stores plus `fence rw,w`
  - use of IO flags _(see prior note)_
  - `sb` and `sh` have missing `rw,w` flags on their fence instruction

### atomic_load

- `memory_order_acquire`
  - missing `r,rw` flags on the fence instruction after the load
- `memory_order_seq_cst`
  - missing `fence rw,rw` before load
  - missing `r,rw` flags on the fence instruction after the load

### atomic_fetch_add,sub,and,or,xor

- `memory_order_release`
  - fence instruction not required, just `.rl` flag on the atomic operation
  - use of IO flags _(see prior note)_
- `memory_order_acq_rel`, `memory_order_seq_cst`
  - fence instruction not required, just `.aqrl` flags on the atomic operation
  - missing `.rl` flag on the atomic operation

### atomic_flags_test_and_set

- `memory_order_release`
  - fence instruction not required, just `.rl`
  - use of IO flags _(see prior note)_
- `memory_order_acq_rel`, `memory_order_seq_cst`
  - missing `.rl` flag on the atomic operation

### atomic_flag_clear

- logic bug, uses amoor instead of amoand to clear
- `memory_order_release`
  - fence instruction not required, just `.rl` flag on the atomic operation
  - use of IO flags _(see prior note)_
- `memory_order_acq_rel`, `memory_order_seq_cst`
  - fence instruction not required, just `.aqrl` flags on the atomic operation
  - missing `.rl` flag on the atomic operation

### atomic_thread_fence

- `memory_order_acquire`
  - missing `r,rw` flags on the fence instruction
- `memory_order_release`
  - missing `rw,w` flags on the fence instruction
- `memory_order_acq_rel`
  - `fence.tso` not implemented
- `memory_order_seq_cst`
  - missing `rw,rw` flags on the fence instruction
